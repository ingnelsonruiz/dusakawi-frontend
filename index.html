<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dusakawi Engine | Auditoría 125 Cols</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .led-blink { animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .card-glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); }
    </style>
</head>
<body class="bg-[#f8fafc] min-h-screen pb-20">

    <div class="max-w-6xl mx-auto pt-8 px-4">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <span class="bg-blue-600 text-white text-[10px] font-black px-2 py-0.5 rounded-md uppercase tracking-widest">Enterprise</span>
                </div>
                <h1 class="text-4xl font-extrabold text-slate-900 tracking-tighter">DUSAKAWI <span class="text-blue-600 font-light">AUDITOR</span></h1>
                <p class="text-slate-500 font-medium text-sm">Validación Integral de Riesgo Cardiovascular (125 Columnas)</p>
            </div>

            <div class="flex items-center gap-4 bg-white p-4 rounded-3xl shadow-sm border border-slate-200 min-w-[280px]">
                <div id="apiSwitch" class="w-10 h-5 bg-slate-200 rounded-full relative transition-all duration-500">
                    <div id="apiDot" class="w-3.5 h-3.5 bg-white rounded-full absolute top-0.5 left-1 transition-all duration-500 shadow-sm"></div>
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <span id="apiLed" class="w-2.5 h-2.5 bg-slate-300 rounded-full led-blink"></span>
                        <span id="apiText" class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Sincronizando...</span>
                    </div>
                    <p id="apiSubtext" class="text-xs text-slate-500 font-medium">Render está conectando</p>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-8">
            <div class="lg:col-span-4 bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 flex flex-col items-center justify-center text-center">
                <div class="relative w-32 h-32 mb-4">
                    <canvas id="qualityChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span id="qualityPercent" class="text-2xl font-black text-slate-800">0%</span>
                    </div>
                </div>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Índice de Integridad</p>
            </div>

            <div class="lg:col-span-8 bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="font-bold text-slate-800 flex items-center gap-2">
                        <i class="fa-solid fa-shield-check text-blue-600"></i> Banderas de Verificación Técnica
                    </h3>
                    <span class="text-[10px] font-black bg-blue-50 text-blue-600 px-3 py-1 rounded-full uppercase">Cobertura 100%</span>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="flagContainer">
                    <div class="flex items-center gap-2 p-3 rounded-2xl bg-slate-50 border border-slate-100 transition-all opacity-40 grayscale" id="flag-ident">
                        <i class="fa-solid fa-circle-check text-green-500"></i> <span class="text-[10px] font-bold text-slate-600 uppercase">Identificación</span>
                    </div>
                    <div class="flex items-center gap-2 p-3 rounded-2xl bg-slate-50 border border-slate-100 transition-all opacity-40 grayscale" id="flag-geo">
                        <i class="fa-solid fa-circle-check text-green-500"></i> <span class="text-[10px] font-bold text-slate-600 uppercase">Geografía</span>
                    </div>
                    <div class="flex items-center gap-2 p-3 rounded-2xl bg-slate-50 border border-slate-100 transition-all opacity-40 grayscale" id="flag-clin">
                        <i class="fa-solid fa-circle-check text-green-500"></i> <span class="text-[10px] font-bold text-slate-600 uppercase">Clínica Base</span>
                    </div>
                    <div class="flex items-center gap-2 p-3 rounded-2xl bg-slate-50 border border-slate-100 transition-all opacity-40 grayscale" id="flag-lab">
                        <i class="fa-solid fa-circle-check text-green-500"></i> <span class="text-[10px] font-bold text-slate-600 uppercase">Laboratorios</span>
                    </div>
                    <div class="flex items-center gap-2 p-3 rounded-2xl bg-slate-50 border border-slate-100 transition-all opacity-40 grayscale" id="flag-mes">
                        <i class="fa-solid fa-circle-check text-green-500"></i> <span class="text-[10px] font-bold text-slate-600 uppercase">Meses Ene-Dic</span>
                    </div>
                    <div class="flex items-center gap-2 p-3 rounded-2xl bg-slate-50 border border-slate-100 transition-all opacity-40 grayscale" id="flag-calc">
                        <i class="fa-solid fa-circle-check text-green-500"></i> <span class="text-[10px] font-bold text-slate-600 uppercase">Calculados</span>
                    </div>
                    <div class="flex items-center gap-2 p-3 rounded-2xl bg-slate-50 border border-slate-100 transition-all opacity-40 grayscale" id="flag-far">
                        <i class="fa-solid fa-circle-check text-green-500"></i> <span class="text-[10px] font-bold text-slate-600 uppercase">Farmacia</span>
                    </div>
                    <div class="flex items-center gap-2 p-3 rounded-2xl bg-slate-50 border border-slate-100 transition-all opacity-40 grayscale" id="flag-nov">
                        <i class="fa-solid fa-circle-check text-green-500"></i> <span class="text-[10px] font-bold text-slate-600 uppercase">Novedades</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="dropZone" class="opacity-30 pointer-events-none transition-all duration-700 bg-white border-4 border-dashed border-slate-200 rounded-[3rem] p-20 text-center mb-10 group hover:border-blue-500 hover:bg-blue-50/30">
            <input type="file" id="fileInput" class="hidden" accept=".csv">
            <div class="w-20 h-20 bg-blue-100 rounded-3xl flex items-center justify-center mx-auto mb-6 transition-all group-hover:bg-blue-600 group-hover:text-white">
                <i class="fa-solid fa-file-csv text-3xl"></i>
            </div>
            <h3 class="text-2xl font-black text-slate-800 tracking-tight">Cargar Reporte Mensual</h3>
            <p class="text-slate-400 font-medium">Arrastre el CSV con las 125 columnas para iniciar auditoría</p>
        </div>

        <div id="resultsArea" class="hidden animate-fade-in">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h3 class="text-xl font-black text-slate-800 tracking-tight italic">HALLAZGOS DETECTADOS</h3>
                <button onclick="exportToExcel()" class="bg-green-600 text-white px-8 py-4 rounded-2xl font-bold hover:bg-green-700 transition-all flex items-center gap-3 shadow-lg shadow-green-100">
                    <i class="fa-solid fa-file-excel"></i> Descargar Informe Técnico
                </button>
            </div>
            <div class="bg-white rounded-[2.5rem] shadow-xl border border-slate-100 overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-900 text-white text-[10px] font-black uppercase tracking-[0.2em]">
                        <tr>
                            <th class="p-6">Referencia Fila</th>
                            <th class="p-6">Identificación</th>
                            <th class="p-6">Detalle de Inconsistencias</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="loader" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-md z-50 flex flex-col items-center justify-center text-white text-center px-10">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-6"></div>
        <h2 class="text-3xl font-black tracking-tighter mb-2">PROCESANDO 125 COLUMNAS</h2>
        <p class="text-blue-300 font-medium italic">El motor de Python está recalculando IMC, TFG y validando catálogos...</p>
    </div>

    <script>
        const API_BASE = "https://api-ejecutor-python.onrender.com";
        let auditResults = [];
        let chart = null;

        // SEMAFORO DE LA API
        async function checkApi() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                if (res.ok) {
                    const data = await res.json();
                    updateStatusUI(true);
                } else {
                    updateStatusUI(false);
                    setTimeout(checkApi, 5000);
                }
            } catch {
                updateStatusUI(false);
                setTimeout(checkApi, 5000);
            }
        }

        function updateStatusUI(online) {
            const dot = document.getElementById('apiDot');
            const bg = document.getElementById('apiSwitch');
            const led = document.getElementById('apiLed');
            const text = document.getElementById('apiText');
            const sub = document.getElementById('apiSubtext');
            const drop = document.getElementById('dropZone');

            if (online) {
                dot.style.left = "24px";
                bg.classList.replace('bg-slate-200', 'bg-green-500');
                led.className = "w-2.5 h-2.5 bg-green-500 rounded-full shadow-[0_0_8px_#22c55e]";
                text.innerText = "API ACTIVA";
                text.className = "text-[10px] font-black text-green-600 uppercase tracking-widest";
                sub.innerText = "Auditando norma técnica";
                drop.classList.remove('opacity-30', 'pointer-events-none');
                drop.classList.add('cursor-pointer');
            } else {
                dot.style.left = "4px";
                bg.classList.replace('bg-green-500', 'bg-slate-200');
                led.className = "w-2.5 h-2.5 bg-amber-500 rounded-full led-blink";
            }
        }

        // CARGA DE ARCHIVO
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => startAudit(e.target.files[0]);

        async function startAudit(file) {
            if (!file) return;
            document.getElementById('loader').classList.remove('hidden');
            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`${API_BASE}/validar`, { method: 'POST', body: formData });
                const data = await res.json();
                processResults(data);
            } catch (err) {
                alert("La conexión falló. Verifica que el archivo sea CSV.");
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        function processResults(data) {
            auditResults = data.detalles;
            document.getElementById('resultsArea').classList.remove('hidden');
            
            // Activar Banderas
            document.querySelectorAll('#flagContainer > div').forEach(el => {
                el.classList.remove('opacity-40', 'grayscale');
                el.classList.add('shadow-md', 'bg-white');
            });

            // Actualizar Gráfico
            const total = data.registros_leidos;
            const errors = data.registros_con_error;
            const ok = total - errors;
            const percent = ((ok / total) * 100).toFixed(1);
            
            document.getElementById('qualityPercent').innerText = percent + "%";
            updateChart(ok, errors);
            renderTable(auditResults);
        }

        function renderTable(items) {
            const body = document.getElementById('tableBody');
            body.innerHTML = items.map(item => `
                <tr class="hover:bg-slate-50/80 transition-all border-l-4 ${item.errores.length > 3 ? 'border-l-red-600' : 'border-l-blue-400'}">
                    <td class="p-6 font-mono text-[10px] text-slate-400 uppercase tracking-tighter">EXCEL_ROW_${item.fila}</td>
                    <td class="p-6 font-black text-slate-900">${item.identificacion}</td>
                    <td class="p-6">
                        <div class="flex flex-wrap gap-2">
                            ${item.errores.map(e => `<span class="bg-red-50 text-red-600 text-[10px] font-bold px-3 py-1 rounded-lg border border-red-100 italic">⚠️ ${e}</span>`).join('')}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateChart(ok, bad) {
            const ctx = document.getElementById('qualityChart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [ok, bad],
                        backgroundColor: ['#2563eb', '#f1f5f9'],
                        borderWidth: 0,
                        cutout: '80%'
                    }]
                },
                options: { plugins: { legend: { display: false } } }
            });
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(auditResults.map(i => ({
                Fila: i.fila,
                Documento: i.identificacion,
                Errores: i.errores.join(" | ")
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Hallazgos_125_Cols");
            XLSX.writeFile(wb, "Dusakawi_Auditoria_Tecnica.xlsx");
        }

        checkApi();
    </script>
</body>
</html>
