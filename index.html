<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dusakawi Auditor Pro | Resoluci√≥n 4505</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg);
            color: #1e293b;
            scroll-behavior: smooth;
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .custom-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
        }

        .dropzone-active {
            border-color: var(--primary);
            background-color: #eff6ff;
            transform: scale(1.02);
        }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.95); }
        }
        .animate-status { animation: pulse-soft 3s infinite; }

        /* Estilo para el scrollbar profesional */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-12">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-12 bg-white p-8 rounded-[3rem] custom-shadow border border-slate-100">
            <div class="flex items-center gap-5">
                <div class="bg-blue-600 text-white w-16 h-16 rounded-[1.5rem] flex items-center justify-center shadow-xl shadow-blue-200">
                    <i class="fa-solid fa-hospital-user text-3xl"></i>
                </div>
                <div>
                    <h1 class="text-4xl font-black tracking-tighter text-slate-900 flex items-center gap-2">
                        DUSAKAWI <span class="text-blue-600 italic">AUDITOR</span>
                        <span class="bg-blue-100 text-blue-600 text-[10px] px-2 py-1 rounded-md tracking-widest font-bold uppercase">Pro v2.0</span>
                    </h1>
                    <p class="text-slate-400 font-bold text-xs uppercase tracking-[0.2em]">
                        Motor de Inteligencia T√©cnica - Resoluci√≥n 4505
                    </p>
                </div>
            </div>

            <div id="statusPill" class="flex items-center gap-4 bg-slate-50 px-6 py-3 rounded-2xl border border-slate-200 shadow-inner group transition-all">
                <div class="relative flex h-3 w-3">
                    <span id="statusPing" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-slate-400 opacity-75"></span>
                    <span id="statusDot" class="relative inline-flex rounded-full h-3 w-3 bg-slate-400"></span>
                </div>
                <div class="flex flex-col">
                    <span id="statusText" class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Enlace API: Desconectado</span>
                    <span id="statusTimer" class="text-[9px] text-slate-400 italic font-medium">Reintentando conexi√≥n...</span>
                </div>
            </div>
        </header>

        <div id="dashboard" class="hidden grid grid-cols-1 md:grid-cols-4 gap-6 mb-12 animate-fade-in">
            <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 custom-shadow hover:translate-y-[-5px] transition-transform">
                <div class="bg-blue-50 w-10 h-10 rounded-xl flex items-center justify-center mb-4"><i class="fa-solid fa-users text-blue-600"></i></div>
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-widest">Poblaci√≥n Total</p>
                <p id="statTotal" class="text-4xl font-black text-slate-800 tracking-tighter">0</p>
            </div>
            <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 custom-shadow hover:translate-y-[-5px] transition-transform">
                <div class="bg-indigo-50 w-10 h-10 rounded-xl flex items-center justify-center mb-4"><i class="fa-solid fa-table-columns text-indigo-600"></i></div>
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-widest">Columnas Mapeadas</p>
                <p id="statCols" class="text-4xl font-black text-indigo-600 tracking-tighter">0</p>
            </div>
            <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 custom-shadow border-l-8 border-l-red-500 hover:translate-y-[-5px] transition-transform text-red-900">
                <div class="bg-red-50 w-10 h-10 rounded-xl flex items-center justify-center mb-4"><i class="fa-solid fa-triangle-exclamation text-red-600"></i></div>
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-widest text-red-400">Pacientes Observados</p>
                <p id="statErrs" class="text-4xl font-black tracking-tighter text-red-600">0</p>
            </div>
            <button onclick="exportarErrores()" class="bg-slate-900 hover:bg-emerald-600 text-white p-8 rounded-[2.5rem] transition-all flex flex-col items-center justify-center gap-2 group shadow-xl shadow-slate-200">
                <i class="fa-solid fa-file-export text-3xl mb-1 group-hover:scale-110 transition-transform"></i>
                <span class="text-[11px] font-extrabold uppercase tracking-[0.2em]">Exportar Hallazgos</span>
            </button>
        </div>

        <div id="dropZone" 
             class="bg-white border-4 border-dashed border-slate-200 rounded-[4rem] p-24 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50/30 transition-all group mb-12 custom-shadow">
            <input type="file" id="fileInput" class="hidden" accept=".csv">
            
            <div class="bg-slate-50 w-28 h-28 rounded-full flex items-center justify-center mx-auto mb-8 group-hover:bg-blue-100 transition-all group-hover:rotate-6 shadow-inner">
                <i class="fa-solid fa-cloud-arrow-up text-5xl text-slate-300 group-hover:text-blue-500 transition-all"></i>
            </div>
            
            <h2 class="text-3xl font-black text-slate-800 mb-3 tracking-tighter">Auditor√≠a Masiva Dusakawi</h2>
            <p class="text-slate-400 max-w-lg mx-auto text-base font-medium leading-relaxed italic">
                Suelte su archivo CSV aqu√≠. El sistema identificar√° el n√∫mero de columna (1-125) y validar√° la integridad de los datos reportados.
            </p>
            <div class="mt-8 flex justify-center gap-4">
                <span class="text-[10px] font-black text-slate-400 uppercase border border-slate-200 px-3 py-1 rounded-lg italic">Separador: Punto y Coma (;)</span>
                <span class="text-[10px] font-black text-slate-400 uppercase border border-slate-200 px-3 py-1 rounded-lg italic">Encoding: Latin-1</span>
            </div>
        </div>

        <div id="loader" class="hidden py-32 text-center">
            <div class="relative inline-block">
                <div class="w-24 h-24 border-8 border-slate-100 border-t-blue-600 rounded-full animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <i class="fa-solid fa-bolt text-blue-600 text-2xl animate-pulse"></i>
                </div>
            </div>
            <h3 class="mt-10 font-black text-slate-800 uppercase tracking-[0.3em] text-lg italic">Analizando 125 Columnas...</h3>
            <p class="text-slate-400 font-medium mt-3 italic animate-pulse">Calculando consistencia cl√≠nica e IMC para cada registro</p>
        </div>

        <div id="resultsContainer" class="space-y-10 mb-20"></div>
    </div>

    <script>
        const API_URL = "https://api-ejecutor-python.onrender.com";
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        let logsParaExportar = [];
        let mapaColumnasUsuario = [];

        // 1. INICIALIZADOR DE CONEXI√ìN (SMART POLLING)
        async function conectar() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if(response.ok) {
                    const statusDot = document.getElementById('statusDot');
                    const statusPing = document.getElementById('statusPing');
                    const statusText = document.getElementById('statusText');
                    
                    statusDot.className = "relative inline-flex rounded-full h-3 w-3 bg-emerald-500";
                    statusPing.className = "animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75";
                    statusText.innerText = "Enlace API: Operativo";
                    statusText.className = "text-[10px] font-black text-emerald-600 uppercase tracking-widest";
                    document.getElementById('statusTimer').innerText = "Sistema de Auditor√≠a Sincronizado";
                }
            } catch (error) {
                setTimeout(conectar, 6000);
            }
        }

        // 2. GESTI√ìN DE CARGA Y MAPEADOR LOCAL
        dropZone.onclick = () => fileInput.click();

        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            // Lectura inicial para mapeo de columnas (No cambia el Backend)
            const preReader = new FileReader();
            preReader.onload = (evt) => {
                const cabecera = evt.target.result.split('\n')[0];
                const separador = cabecera.includes(';') ? ';' : ',';
                mapaColumnasUsuario = cabecera.split(separador).map(c => c.trim().toUpperCase());
                console.log("Mapeo detectado:", mapaColumnasUsuario.length, "columnas");
            };
            preReader.readAsText(file, 'ISO-8859-1');

            // Preparar UI
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('dropZone').classList.add('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('resultsContainer').innerHTML = "";

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_URL}/validar`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (!response.ok) throw new Error(data.detail || "Error estructural en el reporte.");

                procesarRenderizado(data);

            } catch (err) {
                alert("üî¥ ALERTA DE ESTRUCTURA: " + err.message);
                document.getElementById('dropZone').classList.remove('hidden');
            } finally {
                document.getElementById('loader').classList.add('hidden');
                fileInput.value = "";
            }
        };

        // 3. MOTOR DE RENDERIZADO DE RESULTADOS
        function procesarRenderizado(data) {
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('statTotal').innerText = data.resumen.total_filas;
            document.getElementById('statCols').innerText = data.resumen.columnas_leidas;
            document.getElementById('statErrs').innerText = data.resumen.errores_encontrados;

            logsParaExportar = data.detalles;
            const container = document.getElementById('resultsContainer');

            if(data.detalles.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-20 bg-emerald-50 rounded-[4rem] border-4 border-dashed border-emerald-100 animate-pulse">
                        <i class="fa-solid fa-shield-heart text-7xl text-emerald-400 mb-6"></i>
                        <h3 class="text-3xl font-black text-emerald-900">REPORTE DE CALIDAD TOTAL</h3>
                        <p class="text-emerald-600 font-bold italic">No se detectaron hallazgos t√©cnicos en las 125 columnas.</p>
                    </div>`;
                return;
            }

            container.innerHTML = data.detalles.map(paciente => {
                return `
                <article class="bg-white rounded-[3.5rem] border border-slate-200 overflow-hidden custom-shadow hover:shadow-2xl transition-all duration-500">
                    <div class="bg-slate-900 px-10 py-7 flex flex-wrap justify-between items-center gap-6">
                        <div class="flex items-center gap-5">
                            <div class="bg-white/10 w-14 h-14 rounded-2xl flex items-center justify-center text-white backdrop-blur-md">
                                <i class="fa-solid fa-id-card-clip text-xl"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest italic">Documento Paciente</p>
                                <h3 class="text-2xl font-black text-white tracking-tighter">${paciente.identificacion}</h3>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-right hidden sm:block">
                                <p class="text-[10px] font-bold text-slate-400 uppercase">Localizaci√≥n F√≠sica</p>
                                <p class="text-white font-bold italic">Fila Excel: ${paciente.fila}</p>
                            </div>
                            <div class="bg-red-500/10 text-red-400 border border-red-500/30 px-6 py-2 rounded-2xl font-black text-xs uppercase italic tracking-widest">
                                ${paciente.errores.length} Hallazgos
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-10 grid grid-cols-1 md:grid-cols-2 gap-8">
                        ${paciente.errores.map(error => {
                            // C√°lculo din√°mico del n√∫mero de columna basado en el mapeo inicial
                            const numeroColumna = mapaColumnasUsuario.indexOf(error.columna.toUpperCase()) + 1;
                            
                            return `
                            <div class="bg-slate-50 border border-slate-100 p-8 rounded-[2.5rem] relative overflow-hidden group hover:bg-white hover:border-blue-200 transition-all duration-300">
                                <div class="absolute top-0 left-0 w-2 h-full bg-red-500 opacity-20 group-hover:opacity-100 transition-opacity"></div>
                                
                                <div class="flex justify-between items-start mb-6">
                                    <div class="flex flex-col">
                                        <span class="bg-slate-200 text-slate-600 px-3 py-1 rounded-lg text-[9px] font-black uppercase tracking-widest w-fit mb-2">
                                            Columna ${numeroColumna > 0 ? numeroColumna : 'N/A'}
                                        </span>
                                        <h4 class="text-sm font-black text-slate-800 uppercase italic">${error.columna}</h4>
                                    </div>
                                    <div class="bg-red-100 text-red-600 w-10 h-10 rounded-xl flex items-center justify-center shadow-sm">
                                        <i class="fa-solid fa-circle-exclamation"></i>
                                    </div>
                                </div>

                                <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-inner mb-5">
                                    <p class="text-[10px] font-black text-slate-400 uppercase mb-2">Dato Reportado:</p>
                                    <span class="text-lg font-mono font-black text-red-600 italic">"${error.valor}"</span>
                                </div>

                                <div class="space-y-4">
                                    <div class="flex items-start gap-4">
                                        <div class="mt-1"><i class="fa-solid fa-comment-medical text-slate-300 text-sm"></i></div>
                                        <p class="text-sm text-slate-600 font-bold italic leading-snug">${error.mensaje}</p>
                                    </div>
                                    <div class="flex items-start gap-4 bg-blue-50/50 p-4 rounded-2xl border border-blue-100/50">
                                        <div class="mt-1"><i class="fa-solid fa-hand-holding-medical text-blue-500 text-sm"></i></div>
                                        <p class="text-xs text-blue-700 font-semibold italic"><b>Acci√≥n T√©cnica:</b> ${error.sugerencia}</p>
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </article>`;
            }).join('');
            
            // Auto-scroll al primer resultado
            container.scrollIntoView({ behavior: 'smooth' });
        }

        // 4. SISTEMA DE EXPORTACI√ìN INTELIGENTE (XLSX)
        function exportarErrores() {
            if(logsParaExportar.length === 0) return;
            
            const rows = [];
            logsParaExportar.forEach(p => {
                p.errores.forEach(e => {
                    const numCol = mapaColumnasUsuario.indexOf(e.columna.toUpperCase()) + 1;
                    rows.push({
                        "FILA_EXCEL": p.fila,
                        "IDENTIFICACI√ìN_PACIENTE": p.identificacion,
                        "N_COLUMNA": numCol,
                        "NOMBRE_COLUMNA": e.columna,
                        "VALOR_REPORTADO": e.valor,
                        "HALLAZGO_TECNICO": e.mensaje,
                        "RECOMENDACION_AUDITORIA": e.sugerencia,
                        "FECHA_AUDITORIA": new Date().toLocaleDateString()
                    });
                });
            });

            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Informe_Hallazgos");
            XLSX.writeFile(wb, `Auditoria_4505_Dusakawi_${new Date().getTime()}.xlsx`);
        }

        // Ejecutar conexi√≥n inicial
        conectar();
    </script>
</body>
</html>
