<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dusakawi Analytics | Pro Validator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <nav class="gradient-bg text-white p-4 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg"><i class="fa-solid fa-shield-heart text-xl"></i></div>
                <span class="text-xl font-bold tracking-tight">DUSAKAWI <span class="text-blue-400">ENGINE</span></span>
            </div>
            <div class="flex items-center gap-4 text-sm font-medium">
                <span id="apiStatus" class="flex items-center gap-2"><span class="w-2 h-2 bg-green-400 rounded-full animate-ping"></span> Sistema Activo</span>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-8 px-4">
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
            <div class="lg:col-span-2">
                <h2 class="text-3xl font-extrabold text-slate-800 mb-2">Validador de Calidad de Datos</h2>
                <p class="text-slate-500 mb-6">Analice la consistencia de sus 125 columnas de reporte cardiovascular y renal según norma técnica.</p>
                
                <div id="dropZone" class="group relative bg-white border-2 border-dashed border-blue-200 rounded-2xl p-12 text-center transition-all hover:border-blue-500 hover:bg-blue-50 cursor-pointer shadow-sm">
                    <input type="file" id="fileInput" class="hidden" accept=".csv">
                    <i class="fa-solid fa-file-csv text-5xl text-blue-600 mb-4 transition-transform group-hover:scale-110"></i>
                    <p class="text-lg font-semibold text-slate-700">Arrastre el reporte del prestador aquí</p>
                    <p class="text-sm text-slate-400 mt-1">El sistema detectará errores de formato, lógica y rango automáticamente.</p>
                </div>
            </div>

            <div class="glass-card p-6 rounded-2xl shadow-xl flex flex-col items-center justify-center">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Indice de Calidad</h3>
                <canvas id="qualityChart" width="200" height="200"></canvas>
                <div id="complianceLabel" class="text-3xl font-black mt-4 text-slate-800">0%</div>
            </div>
        </div>

        <div id="statsGrid" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 hidden">
            <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm">
                <p class="text-xs font-bold text-slate-400 uppercase">Procesados</p>
                <p id="totalCount" class="text-2xl font-bold">0</p>
            </div>
            <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm">
                <p class="text-xs font-bold text-red-400 uppercase">Con Error</p>
                <p id="errorCount" class="text-2xl font-bold text-red-600">0</p>
            </div>
            <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm">
                <p class="text-xs font-bold text-blue-400 uppercase">Validaciones</p>
                <p class="text-2xl font-bold">125 Cols</p>
            </div>
            <button onclick="exportToExcel()" class="bg-slate-900 text-white p-5 rounded-xl hover:bg-slate-800 transition-all flex items-center justify-center gap-2 font-bold shadow-lg shadow-slate-200">
                <i class="fa-solid fa-file-export"></i> Descargar Informe
            </button>
        </div>

        <div id="resultsTable" class="bg-white rounded-2xl shadow-2xl border border-slate-200 overflow-hidden hidden">
            <div class="p-6 border-bottom border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-700">Inconsistencias Detectadas</h3>
                <input type="text" id="filterInput" placeholder="Filtrar por ID de Paciente..." class="px-4 py-2 border rounded-lg text-sm w-64 outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-slate-100 text-slate-500 text-xs font-bold uppercase">
                        <tr>
                            <th class="px-6 py-4 text-left">Fila</th>
                            <th class="px-6 py-4 text-left">Identificación</th>
                            <th class="px-6 py-4 text-left">Hallazgos</th>
                        </tr>
                    </thead>
                    <tbody id="errorBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="loader" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md hidden z-50 flex flex-col items-center justify-center text-white">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-xl font-bold animate-pulse">Analizando integridad de datos...</p>
    </div>

    <script>
        const API_URL = "https://api-ejecutor-python.onrender.com/validar";
        let globalErrors = [];
        let chartInstance = null;

        // Init Chart
        const ctx = document.getElementById('qualityChart').getContext('2d');
        function updateChart(success, errors) {
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [success, errors],
                        backgroundColor: ['#3b82f6', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '80%', plugins: { legend: { display: false } } }
            });
        }
        updateChart(1, 0);

        // Upload Logic
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleUpload(e.target.files[0]);

        async function handleUpload(file) {
            if (!file) return;
            document.getElementById('loader').classList.remove('hidden');
            
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(API_URL, { method: 'POST', body: formData });
                const data = await response.json();
                processResults(data);
            } catch (err) {
                alert("Error de conexión: " + err.message);
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        function processResults(data) {
            globalErrors = data.detalles;
            document.getElementById('statsGrid').classList.remove('hidden');
            document.getElementById('resultsTable').classList.remove('hidden');
            
            document.getElementById('totalCount').innerText = data.registros_leidos;
            document.getElementById('errorCount').innerText = data.registros_con_error;
            
            const score = ((data.registros_leidos - data.registros_con_error) / data.registros_leidos * 100).toFixed(1);
            document.getElementById('complianceLabel').innerText = score + "%";
            
            updateChart(data.registros_leidos - data.registros_con_error, data.registros_con_error);
            renderTable(globalErrors);
        }

        function renderTable(items) {
            const tbody = document.getElementById('errorBody');
            tbody.innerHTML = items.map(item => `
                <tr class="hover:bg-blue-50/50 transition-colors">
                    <td class="px-6 py-4 font-mono text-slate-400 text-sm">#${item.fila}</td>
                    <td class="px-6 py-4 font-bold text-slate-700">${item.identificacion}</td>
                    <td class="px-6 py-4">
                        <div class="space-y-2">
                            ${item.errores.map(e => `
                                <div class="flex items-center gap-2 text-xs font-medium text-red-700 bg-red-50 p-2 rounded-lg border border-red-100">
                                    <i class="fa-solid fa-circle-exclamation text-red-400"></i> ${e}
                                </div>
                            `).join('')}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(globalErrors.map(e => ({
                Fila: e.fila,
                Paciente: e.identificacion,
                Hallazgos: e.errores.join(" | ")
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Errores");
            XLSX.writeFile(wb, "Reporte_Dusakawi_Inconsistencias.xlsx");
        }

        document.getElementById('filterInput').oninput = (e) => {
            const val = e.target.value.toLowerCase();
            renderTable(globalErrors.filter(i => i.identificacion.toString().toLowerCase().includes(val)));
        };
    </script>
</body>
</html>